WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * <%= size %>), greatest(!pixel_width!,!pixel_height!) * <%= size %>) as cell) SELECT hgrid.cell as the_geom_webmercator, count(i.cartodb_id) as points_count, count(i.cartodb_id)/power( <%= size %> * CDB_XYZ_Resolution(16), 2 ) as points_density, 1 as cartodb_id FROM hgrid, (SELECT * from fourweeks WHERE ts > to_timestamp(<%= start / 1000 | 0 %>) AND ts <= to_timestamp(<%= stop / 1000 | 0 %>)) i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell
